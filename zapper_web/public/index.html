<!DOCTYPE html>

<head>
  <title>zapper-map</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css"/>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
</head>

<body>
  <div id="container">
    <h1>誘捕桶地圖</h1>
    <div id="map"></div>
    <div id="list">
      <h2>事件</h2>
      <ol >
        <li style="background-color: #BD3F32">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.85)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.7)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.55)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.4)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.25)">(1, 19 ,24), 230 times</li>
        <li style="background-color: #BD3F32">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.85)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.7)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.55)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.4)">(1, 19 ,24), 230 times</li>
        <li style="background-color: rgba(203, 87, 75, 0.25)">(1, 19 ,24), 230 times</li>
      </ol>
    </div>
  </div>
</body>
<script type="text/javascript">
//var mymap = L.map('map').setView([51.505, -0.09], 13);
// light theme
// 	L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/light-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hpbmc1NiIsImEiOiJjaXNiZmYydGMwMTN1MnpwbnNqNWVqM2plIn0.k7h-PUGX7Tl5xLwDH3Qpsg', {
//     attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
//     maxZoom: 18,
//     id: 'your.mapbox.project.id',
// }).addTo(mymap);

/*		L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiY2hpbmc1NiIsImEiOiJjaXNiZmYydGMwMTN1MnpwbnNqNWVqM2plIn0.k7h-PUGX7Tl5xLwDH3Qpsg', {
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
    maxZoom: 18,
    id: 'your.mapbox.project.id',
}).addTo(mymap);*/
  var map = L.map('map').setView([22.969919,120.210703], 13);
  mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

  L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v9/tiles/256/{z}/{x}/{y}?access_token={accessToken}', {
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
      maxZoom: 18,
      id: 'your.mapbox.project.id',
      accessToken: 'pk.eyJ1IjoiY2hpbmc1NiIsImEiOiJjaXNiZmYydGMwMTN1MnpwbnNqNWVqM2plIn0.k7h-PUGX7Tl5xLwDH3Qpsg'
  }).addTo(map);
        
  /* Initialize the SVG layer */
  //mymap._initPathRoot(); 
  L.svg().addTo(map);
  /* We simply pick up the SVG from the map object */
  var svg = d3.select("#map").select("svg");
  g = svg.append("g");

  d3.json("data.json", function(collection) {
    collection.forEach(function(d) {
      d.LatLng = new L.LatLng(d.lng, d.lat)

      switch(d.status) {
        case 1:
            d.color = "65FF29";
            break;
        case 2:
            d.color = "E8DF2E";
            break;
        case 3:
            d.color = "FFC440";
            break;
        case 4:
            d.color = "E8732E";
            break;
        case 5:
            d.color = "FF3333";
            break;
        default:
            d.color = "FFC440";
            break;
      }

    });
    var radius = 5;
    
    var feature = g.selectAll("circle")
      .data(collection)
      .enter().append("circle")
      .style("stroke", function(d) { return d.color })
      .style("opacity", .6) 
      .style("fill", function(d) { return d.color })
      .attr("stroke-width", 20)
      .attr("r", radius)
      .attr('id', function(d) { return "z"+d.zapper_id })
      .each(pulse);  
    
    map.on("viewreset", update);
    update();

    

    function update() {
      feature.attr("transform", 
      function(d) { 
        return "translate("+ 
          map.latLngToLayerPoint(d.LatLng).x +","+ 
          map.latLngToLayerPoint(d.LatLng).y +")";

        }
      )
    }

    function pulse() {
      var circle = d3.select(this);
      circle = circle.transition()
        .duration(1000)
        .attr("stroke-width", 20)
        .attr("r", function(d) { 
          if (d.u_or_d == "up")
            return 10;
          else if (d.u_or_d == "down")
            return 1;
          else
            return 7;
        })
        .ease('sine');
    }

    repeat();

    function repeat() {
      setInterval(function(){       
        var circle = d3.selectAll("circle");
        circle = circle.transition()
          .duration(1000)
          .attr("stroke-width", 20)
          .attr("r", function(d){return Math.floor((Math.random() * 20) + 1)})
          .ease('sine'); 
      }, 3000);
    }

  });

	
</script>
</html>
